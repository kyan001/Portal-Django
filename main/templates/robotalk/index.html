{% extends "base.html" %}
{% block title %}RoboTalk{% endblock %}
{% block icon %}<link rel="icon" href="/static/img/Logo_Robotalk.png">{% endblock %}

{% block css %}
<style>
    .container-fluid {
        font-family: "微软雅黑";
    }
    .user-img {
        width: 100%;
    }
    .user-img:hover {
        -webkit-transform: scale(1.2);
           -moz-transform: scale(1.2);
             -o-transform: scale(1.2);
                transform: scale(1.2);
    }
    .col {
        padding-left: 5px;
        padding-right: 5px;
    }
    .loading {
        -webkit-transform: rotate(1080deg);
           -moz-transform: rotate(1080deg);
             -o-transform: rotate(1080deg);
                transform: rotate(1080deg);
        -webkit-transition: all 3s linear;
           -moz-transition: all 3s linear;
             -o-transition: all 3s linear;
                transition: all 3s linear;
    }
    .list-group {
        margin-bottom: 5px;
    }
    .chat-li {
        padding: 12px;
    }
    .text-from {
        color: rgba(0,0,0,0.4);
    }
</style>
{% endblock css %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-xs-12 col-sm-8 col-sm-offset-2">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <div class="panel-title">
                        RoboTalk
                        <span class="pull-right">
                            <span class="glyphicon glyphicon-comment"></span>
                            <span id="counts"></span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="panel-body">
                <div id="chat-zone">
                </div>
            </div>
            <div class="input-group">
                <span class="input-group-addon">
                    <span id='loading-icon' class="glyphicon glyphicon-comment"></span>
                </span>
                <input type="text" name="userinput" class="form-control" placeholder="说点儿什么" autofocus="true">
                <span class="input-group-btn">
                    <button id='sendbtn' class="btn btn-success" type="button" onclick='sendmsg()'>
                        发送
                    </button>
                </span>
            </div><!-- /input-group -->
        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
<script>
    $(function(){
        $('input[name="userinput"]').keydown(function(event){
            if(event.keyCode == 13){ // press enter
                $('#sendbtn').click()
            }
        })
        getResponse('Hi')
    })
    function showLoading(enable){
        $('#loading-icon').removeClass('glyphicon-refresh').removeClass('glyphicon-comment')
        if(enable){
            $('#loading-icon').addClass('glyphicon-refresh')
            $('#loading-icon').addClass('loading')
        } else {
            $('#loading-icon').addClass('glyphicon-comment')
            $('#loading-icon').removeClass('loading')
        }
    }
    function sendmsg(){
        var input_ele = $('input[name="userinput"]')
        var input_txt = input_ele.val()
        if(input_txt != ''){
            addChat(input_txt, 'me')  // show this chat on screen
            getResponse(input_txt)  // ask for robo responses
            input_ele.val('')
        }
        input_ele.focus()
    }
    function getResponse(userinput){
        if(userinput==''){
            return false
        }
        showLoading(true)
        $.ajax({
            type: 'GET',
            url: '/robotalk/getresponse',
            data: {
                'txt': userinput,
            },
            success: function(data){
                if(data.error){
                    alert("Error:"+data.error)
                }
                for (robo in data.result){
                    addChat(data.result[robo].txt, robo)
                }
                $('#counts').text(data.count)
                showLoading(false)
            },
            dataType: 'json',
        })
    }

    var timer_aC
    function addChat(word, from){
        clearTimeout(timer_aC)
        // Create chat-row
        var crow = $("<div class='row'></div>")
        // Create chat-col
        var ccol = $('<div></div>').addClass('col-xs-9 col-sm-8 col')
        if(from=='me'){
            ccol.addClass('col-xs-offset-1 col-sm-offset-3')
        }
        // Create user-img
        var ucol = $('<div></div>').addClass('col-xs-2 col-sm-1 col')
        var uimg = $('<img>').addClass('user-img befast')
        // Create chat-ul
        var cul = $('<ul></ul>').addClass('list-group')
        // Create chat-ele
        var cele = $('<span></span>').addClass('list-group-item chat-li')
        var cfrom = $('<span class="pull-right text-from"></span>').hide()
        uimg.attr('title', from)
        uimg.click(function(){$('.text-from').show().delay(500).fadeOut()});
        switch(from){
            case 'me':
                cul.addClass('text-right')
                cele.addClass('list-group-item-success')
                uimg.attr('src', "/static/img/robotalk/fromme.png")
                break;
            case 'feifei':
                cele.addClass('list-group-item-danger')
                uimg.attr('src', "/static/img/robotalk/fromfeifei.png")
                cfrom.text('@菲菲')
                break;
            case 'simsimi':
                cele.addClass('list-group-item-info')
                uimg.attr('src', "/static/img/robotalk/fromsimsimi.png")
                cfrom.text('@Simsimi')
                break;
            case 'superfarmer.net':
                cele.addClass('list-group-item-warning')
                uimg.attr('src', "/static/img/Logo_Robotalk.png")
            default:
                uimg.attr('src', "/static/img/robotalk/fromme.png")
                break;
        }
        // Appends
        cele.append(word).append(cfrom)
        ucol.append(uimg)
        cul.append(cele)
        ccol.append(cul)
        if(from=='me'){
            crow.append(ccol).append(ucol)
        } else {
            crow.append(ucol).append(ccol)
        }
        crow.hide()
        $('#chat-zone').append(crow)
        crow.slideDown()
        timer_aC = setTimeout(function(){
            $("html, body").animate({scrollTop: $(document).height()}, 500)
        }, 100)
    }
</script>
{% endblock js %}

{% block footer %}{% endblock %}
