{% extends "base.html" %}
{% block title %}RoboTalk{% endblock %}
{% block icon %}<link rel="icon" href="/static/img/Logo_Robotalk.png">{% endblock %}

{% block css %}
<style>
    .container-fluid {
        font-family: "微软雅黑";
    }
    .user-img {
        width: 100%;
    }
    .user-img:hover {
        -webkit-transform: scale(1.2);
           -moz-transform: scale(1.2);
             -o-transform: scale(1.2);
                transform: scale(1.2);
    }
    .col {
        padding-left: 5px;
        padding-right: 5px;
    }

    @keyframes rotate360 {
        from {transform: rotate(0deg);}
        to {transform: rotate(360deg);}
    }
    @-webkit-keyframes rotate360 {
        from {-webkit-transform: rotate(0deg);}
        to {-webkit-transform: rotate(360deg);}
    }
    @-moz-keyframes rotate360 {
        from {-moz-transform: rotate(0deg);}
        to {-moz-transform: rotate(360deg);}
    }
    @-ms-keyframes rotate360 {
        from {-ms-transform: rotate(0deg);}
        to {-ms-transform: rotate(360deg);}
    }
    @-o-keyframes rotate360 {
        from {-o-transform: rotate(0deg);}
        to {-o-transform: rotate(360deg);}
    }
    .loading {
        -webkit-animation: rotate360 1s linear infinite;
           -moz-animation: rotate360 1s linear infinite;
            -ms-animation: rotate360 1s linear infinite;
             -o-animation: rotate360 1s linear infinite;
                animation: rotate360 1s linear infinite;
    }
    .list-group {
        margin-bottom: 5px;
    }
    .chat-li {
        padding: 12px;
    }
    .text-from {
        color: rgba(0,0,0,0.5);
    }
    .text-quote {
        opacity: 0.7;
        font-style: italic;
    }
</style>
{% endblock css %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-xs-12 col-sm-8 col-sm-offset-2">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <div class="panel-title">
                        RoboTalk
                        <span class="pull-right" title="已运行 {{starttime}}">
                            <span class="glyphicon glyphicon-comment"></span>
                            <span id="counts"></span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="panel-body">
                <div id="chat-zone">
                </div>
            </div>
            <div class="input-group">
                <span class="input-group-addon">
                    <span id='loading-icon' class="glyphicon glyphicon-comment"></span>
                </span>
                <input type="text" name="userinput" class="form-control" placeholder="说点儿什么" autofocus="true">
                <span class="input-group-btn">
                    <button id='sendbtn' class="btn btn-success" type="button" onclick='sendmsg()'>
                        发送
                    </button>
                </span>
            </div><!-- /input-group -->
        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
<script>
    $(function(){
        $('input[name="userinput"]').keydown(function(event){
            if(event.keyCode == 13){ // press enter
                $('#sendbtn').click()
            }
        })
        getResponse('Hi')
    })

    var lastchat = {
        'whotalk': '',  // last chat from who
    }

    function randomNum(){ // 0-100
        return Math.random() * 100
    }

    function randomEvents(){
        var RCTE_rate = lastchat['RCTE'] ? 55 : 25  // 25% chance to start a RCTE, 55% chance to reply a robo
        var isRoboChatToEach = randomNum() < RCTE_rate
        lastchat['RCTE'] = isRoboChatToEach
        if(isRoboChatToEach){
            roboChatToEachEvent()
        }
    }

    function roboChatToEachEvent(){
        // decide who talk
        var whotalk = ""
        var qualified = {}
        if(lastchat['feifei'].length < 25 && lastchat['whotalk'] != 'feifei'){
            qualified['feifei'] = true
        } else {
            qualified['feifei'] = false
        }
        if(lastchat['simsimi'].length < 25 && lastchat['whotalk'] != 'simsimi'){
            qualified['simsimi'] = true
        } else {
            qualified['simsimi'] = false
        }
        if(qualified['simsimi'] && qualified['feifei']){
            whotalk = randomNum()>50 ? 'feifei' : 'simsimi'
        } else if(qualified['feifei']){
            whotalk = 'feifei'
        } else if(qualified['simsimi']) {
            whotalk = 'simsimi'
        } else {
            return null
        }
        var wholisten = whotalk=='feifei' ? 'simsimi' : 'feifei'
        // same person cannot talk twice
        if(lastchat['whotalk'] != whotalk){
            // talk
            getResponse(lastchat[wholisten], whotalk, wholisten)
        }
        console.log('触发事件：机器人之间对话，由 ' + whotalk + ' 对 ' + wholisten + ' 说')
    }

    function showLoading(enable){
        $('#loading-icon').removeClass('glyphicon-refresh').removeClass('glyphicon-comment')
        if(enable){
            $('#loading-icon').addClass('glyphicon-refresh')
            $('#loading-icon').addClass('loading text-danger')
        } else {
            $('#loading-icon').addClass('glyphicon-comment')
            $('#loading-icon').removeClass('loading text-danger')
        }
    }

    function sendmsg(){
        var input_ele = $('input[name="userinput"]')
        var input_txt = input_ele.val()
        if(input_txt != ''){
            addChat(input_txt, 'me')  // show this chat on screen
            getResponse(input_txt)  // ask for robo responses
            input_ele.val('')
        }
        input_ele.focus()
    }

    function getResponse(userinput, from_, to_){
        // get inputs
        if(userinput==''){
            return false
        }
        var from_ = arguments[1] || 'all'
        var to_ = arguments[2] || 'all'

        showLoading(true)

        var param ={
            'txt': userinput,
        }
        if(from_ != 'all' && from_ != 'all'){
            param['from'] = from_
        }
        // remote get
        $.ajax({
            type: 'GET',
            url: '/robotalk/getresponse',
            data: param,
            success: function(data){
                if(data.error){
                    alert("Error:"+data.error)
                }
                for (robo in data.result){
                    addChat(data.result[robo].txt, robo, to_)
                }
                $('#counts').text(data.count)
                showLoading(false)
                randomEvents()
            },
            dataType: 'json',
        })
    }


    var timer_aC
    function addChat(word, from_, to_){
        if(word == ''){
            return
        }
        clearTimeout(timer_aC)
        lastchat[from_] = word// remember last words eachone said
        lastchat['whotalk'] = from_
        to_ = arguments[2] || 'all'
        // Create chat-row
        var crow = $("<div class='row'></div>")
        // Create chat-col
        var ccol = $('<div></div>').addClass('col-xs-9 col-sm-8 col')
        if(from_=='me'){
            ccol.addClass('col-xs-offset-1 col-sm-offset-3')
        }
        // Create user-img
        var ucol = $('<div></div>').addClass('col-xs-2 col-sm-1 col')
        var uimg = $('<img>').addClass('user-img befast')
        // Create chat-ul
        var cul = $('<ul></ul>').addClass('list-group')
        // Create chat-ele
        var cele = $('<span></span>').addClass('list-group-item chat-li')
        for (i in ROBOS){
            if(ROBOS[i].key == from_){
                uimg.attr('title', ROBOS[i].name)
                break
            }
        }
        function styleByFrom(from){
            switch (from) {
                case 'me':
                    cul.addClass('text-right')
                    cele.addClass('list-group-item-success')
                    uimg.attr('src', "/static/img/robotalk/fromme.png")
                    return
                case 'superfarmer.net':
                    cele.addClass('list-group-item-primary')
                    uimg.attr('src', "/static/img/Logo_Robotalk.png")
                    return
            }
            for(i in ROBOS){
                if(from == ROBOS[i].key){
                    cele.addClass('list-group-item-' + ROBOS[i].style)
                    uimg.attr('src', "/static/img/robotalk/" + ROBOS[i].headimg)
                    return
                }
            }
            uimg.attr('src', "/static/img/robotalk/fromunknown.png")
        }
        styleByFrom(from_)
        // Create reply quote
        var cquote = $('<span class="text-quote"></span>')
        if(to_ != 'all'){
            cquote.append("“" + lastchat[to_] + "”<br/>")
        }
        // Appends
        cele.append(cquote).append(word)
        ucol.append(uimg)
        cul.append(cele)
        ccol.append(cul)
        crow.hide()
        if(from_=='me'){
            crow.append(ccol).append(ucol)
        } else {
            crow.append(ucol).append(ccol)
        }
        $('#chat-zone').append(crow)
        crow.slideDown()
        timer_aC = setTimeout(function(){
            $("html, body").animate({scrollTop: $(document).height()}, 500)
        }, 100)
    }
</script>
{% endblock js %}

{% block footer %}{% endblock %}
