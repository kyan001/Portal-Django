{% extends "progress/base.html" %}
{% load i18n %}


{% block title %}{% trans "进度" %}{% trans "：" %}{{ opus.name }}{% endblock title %}


{% load tags_url %}


{% block css %}
<style>
    .progress-card .table {
        margin: 0;
    }
    .progress-card .panel-heading {
        overflow-x: auto;
        overflow-y: hidden;
        word-break: keep-all;
    }
    /* progress bar */
    .progress-card .progress {
        height: 25px;
        line-height: 25px;
        margin-bottom: 0;
    }
    .progress-card .progress .progress-bar {
        line-height: inherit;
    }
    .editable {
        width: 100%;
    }
    input[name="current"] {
        text-align: right;
    }
    form {
        margin-bottom: 0;
    }
    .form-group {
        margin-bottom: 0;
    }
    #saveform th {
        min-width: 6em;
    }
    #title-tr,
    #rating-tr,
    #tag-tr,
    #douban-info-panel {
        display: none;
    }
    #color-indicator {
        color: transparent;
    }
    @media (max-width: 768px) {
        #left-half-panel,
        #right-half-panel {
            padding-left: 0;
            padding-right: 0;
        }
    }
    #opus-chapinfo * {
        vertical-align: top;
    }
</style>
{% endblock css %}


{% block nav-btn %}
    <div class="btn-group">
        {% if prg.status == 'deactivated' or prg.status == 'done' %}
            <a class="btn btn-warning btn-sm" href="/progress/archive">
                <span class="glyphicon glyphicon-arrow-left"></span>
                {% trans "进度存档" %}
            </a>
        {% else %}
            <a class="btn btn-warning btn-sm" href="/progress/list">
                <span class="glyphicon glyphicon-arrow-left"></span>
                {% trans "进度列表" %}
            </a>
        {% endif %}
        <a class="btn btn-warning btn-sm dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <span class="caret"></span>
        </a>
        {% include 'progress/navlink.html' %}
    </div>
{% endblock nav-btn %}


{% block function-btn %}
    <a href="/progress/new" class="btn btn-success btn-sm hide-when-edit">
        <span class="glyphicon glyphicon-plus"></span>
        <span class="hidden-xs">{% trans "新增进度" %}</span>
    </a>
{% endblock function-btn %}


{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-12 col-xs-12 progress-card" progressid="{{ prg.id }}">
            <div class="panel panel-primary" id="main-panel">
                <div class="panel-heading text-nowrap">
                    <span class="panel-title">
                        <a class="btn btn-primary btn-xs"
                          data-toggle="tooltip"
                          data-placement="right"
                          data-container="body"
                          href="/opus/detail?id={{opus.id}}"
                          title="{% trans '分享你的进度信息' %}">
                            <span class="glyphicon glyphicon-qrcode"></span>
                        </a>
                        《<strong id="opus-name">{{ opus.name }}</strong>》
                        <span id="opus-chapinfo"></span>
                        <span id="loading-icon" hidden>
                            <span class="loading circling glyphicon glyphicon-refresh"></span>
                        </span>
                        {% if opus.comment %}
                            <em class="comment small">
                                {{ opus.comment }}
                            </em>
                        {% endif %}
                    </span>
                </div>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped active progress-bar-{{ prg.contextual }}" style="width: {{ prg.persent }}%; min-width: 7em">
                        {% if opus.total == 0 %}
                            <strong>{{ prg.current }} / ∞</strong>
                        {% else %}
                            <strong>{{ prg.current }} / {{ opus.total }}</strong>
                            <span class="pull-right">{{ prg.persent }}%</span>
                        {% endif %}
                    </div>
                </div>
                <div class="panel-body second-panel-body">
                    <div class="row">
                        <div id="left-half-panel" class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                            <form id="saveform" action="/progress/update/" method="post">
                                {% csrf_token %}
                                <input name="id" type="hidden" value="{{prg.id}}">
                                <div class="panel panel-primary">
                                    <div class="panel-heading">
                                        <span>{% trans "进度信息" %}</span>
                                    </div>
                                    <div class="panel-body">
                                        {% if prg.status == "deactivated" %}
                                            <span class="label label-danger center-block">{% trans "已冻结" %}</span>
                                        {% endif %}
                                        <table class="table table-condensed table-hover">
                                            <tr>
                                                <th>{% trans "状态" %}</th>
                                                <td>
                                                    {{ prg.get_status_display }}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>{% trans "百分比" %}</th>
                                                <td>{{prg.persent}}%</td>
                                            </tr>
                                            <tr class="text-info" id="name-tr" data-toggle="popover" data-placement="top" data-container="body">
                                                <th>{% trans "名称" %}</th>
                                                <td class="text-info">
                                                    <div class="input-group">
                                                        <span class="input-group-addon input-sm">《</span>
                                                        <input class="editable form-control"
                                                          name="name"
                                                          type="text"
                                                          value="{{opus.name}}"
                                                          data-original="{{opus.name}}"
                                                          autocomplete="off"
                                                          placeholder="{{opus.name}}"
                                                          required="required">
                                                        <span class="input-group-addon input-sm">》</span>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr class="text-info">
                                                <th>{% trans "备注" %}</th>
                                                <td class="text-info">
                                                    <input class="editable form-control"
                                                      name="comment"
                                                      type="text"
                                                      value="{{opus.comment}}"
                                                      data-original="{{opus.comment}}"
                                                      placeholder="{{opus.comment}}"
                                                      autocomplete="off">
                                                </td>
                                            </tr>
                                            <tr class="text-info">
                                                <th>{% trans "总共" %}</th>
                                                <td class="text-info">
                                                    <input class="editable form-control"
                                                      name="total"
                                                      type="number"
                                                      min="0"
                                                      placeholder="{{opus.total}}"
                                                      value="{{opus.total}}"
                                                      data-original="{{opus.total}}"
                                                      autocomplete="off"
                                                      oninput="RENDER.syncTotal()">
                                                </td>
                                            </tr>
                                            <tr class="text-info">
                                                <th>{% trans "当前进度" %}</th>
                                                <td class="text-info">
                                                    <div class="form-group form-group-lg has-feedback">
                                                        <div class="input-group">
                                                            <span class="input-group-btn">
                                                                <div class="btn btn-lg btn-default" role="button" onclick="FORM.addOneCurrent()">
                                                                    <span class="glyphicon glyphicon-plus"></span>
                                                                </div>
                                                            </span>
                                                            <input class="editable form-control"
                                                              name="current"
                                                              type="number"
                                                              min="0"
                                                              max="{{opus.total|default:''}}"
                                                              value="{{prg.current}}"
                                                              data-original="{{prg.current}}"
                                                              onfocus="if(this.value==this.dataset.original){this.value=''}"
                                                              onblur="if(this.value==''){this.value=this.dataset.original}"
                                                              placeholder="{{prg.current}}">
                                                            <span class="form-control-feedback" aria-hidden="true">
                                                                <span>/</span>
                                                                <span id="total-as-feedback"></span>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr class="text-info" title="{{prg.weblink}}">
                                                <th>{% trans "链接" %}</th>
                                                <td class="text-info">
                                                    <div class="input-group">
                                                        {% if prg.weblink and prg.weblink|isurl %}
                                                            <span class="input-group-btn">
                                                                <a class="btn btn-default"
                                                                  data-toggle="tooltip"
                                                                  data-placement="right"
                                                                  data-container="body"
                                                                  title="{% trans '在新窗口打开链接' %}"
                                                                  href="{{prg.weblink}}"
                                                                  target="_blank">
                                                                    <span class="glyphicon glyphicon-link"></span>
                                                                    <span class="glyphicon glyphicon-new-window"></span>
                                                                </a>
                                                            </span>
                                                        {% else %}
                                                            <span class="input-group-addon">
                                                                <span class="glyphicon glyphicon-link"
                                                                  data-toggle="tooltip"
                                                                  data-placement="right"
                                                                  data-container="body"
                                                                  title="http://">
                                                                </span>
                                                            </span>
                                                        {% endif %}
                                                        <input class="editable form-control"
                                                          name="weblink"
                                                          type="text"
                                                          value="{{prg.weblink}}"
                                                          data-original="{{prg.weblink}}"
                                                          placeholder="{{prg.weblink|default:'http://'}}">
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </div><!--.panel-body-->
                                    <div id="edit-btn" class="show-when-edit">
                                        <div class="btn-group btn-group-flex">
                                            <a id="save" class="btn flex-10 btn-success" role="button" onclick="FORM.saveEdit()">
                                                <span class="glyphicon glyphicon-ok"></span>
                                                {% trans "保存" %}
                                            </a>
                                            <a id="cancel" class="btn flex-2 btn-default" role="button" onclick="FORM.cancelEdit()">
                                                <span class="glyphicon glyphicon-remove"></span>
                                            </a>
                                        </div>
                                    </div><!--#edit-btn-->
                                </div><!--.panel-->
                            </form>
                        </div><!--.col#left-half-panel-->
                        <div id="right-half-panel" class="col-xs-12 col-sm-12 col-md-6 col-lg-6 hide-when-edit">
                            <div class="panel panel-primary">
                                <div class="panel-heading">
                                    <span>{% trans "时间信息" %}</span>
                                </div>
                                <div class="panel-body">
                                    <table class="table table-condensed table-hover">
                                        <tr>
                                            <th>{% trans "开始时间" %}</th>
                                            <td>
                                                <span>{{prg.created|date:"Y-m-d H:i"}}</span>
                                                <small class="text-muted">{{aux.time.c2n}}</small>
                                            </td>
                                        </tr>
                                        <tr>
                                            {% ifequal prg.status "done" %}
                                                <th>{% trans "完成时间" %}</th>
                                            {% else %}
                                                <th>{% trans "上次更新" %}</th>
                                            {% endifequal %}
                                            <td>
                                                <span>{{prg.modified|date:"Y-m-d H:i" }}</span>
                                                <small class="text-muted">{{aux.time.m2n}}</small>
                                            </td>
                                        </tr>
                                        {% if aux.time.speed %}
                                            <tr class="text-success">
                                                <td>{% trans "平均速度" %}</td>
                                                <td>
                                                    {{ aux.time.speed }}
                                                    <small id="speed-unit" class="text-muted">
                                                        {% trans "每个" %}
                                                    </small>
                                                </td>
                                            </tr>
                                        {% endif %}
                                        {% if prg.status == "done" %}
                                            <tr class="text-success">
                                                <td>{% trans "用时" %}</td>
                                                <td>{{ aux.time.c2m }}</td>
                                            </tr>
                                        {% elif aux.esti.finish_date %}
                                            <tr class="text-success">
                                                <td>{% trans "预计完成" %}</td>
                                                <td>
                                                    <span>{{aux.esti.finish_date|date:"Y-m-d"}}</span>
                                                    <small class="text-muted">{{aux.esti.finish_time}}</small>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    </table>
                                </div><!--.panel-body-->
                            </div><!--.panel-->
                            <div id="douban-info-panel" class="panel panel-primary">
                                <div class="panel-heading">
                                    <span><strong>{% trans "作品信息" %}</strong></span>
                                    <span class="pull-right">
                                        <a id="opus-cover" class="btn btn-xs btn-primary" role="button">
                                            <span class="glyphicon glyphicon-picture"></span>
                                            {% trans "封面" %}
                                        </a>
                                        <a id="opus-type-a" class="btn btn-xs btn-primary" href="" target="_blank">
                                            <span id="opus-type-icon" class="glyphicon"></span>
                                        </a>
                                    </span>
                                </div>
                                <div class="panel-body">
                                    <div id="opus-image-row" class="row">
                                        <div class="col-xs-12">
                                            <img id="opus-wordcloud" class="img-responsive center-block">
                                        </div>
                                    </div>
                                    <table class="table table-condensed table-hover">
                                        <tr id="title-tr">
                                            <td colspan="2">
                                                《<a id="title-link" href="" target="_blank"></a>》
                                                <span class="text-muted" id="original-title"></span>
                                                <span id="color-indicator" class="btn btn-xs btn-link pull-right" title="{% trans '作品代表色' %}" data-toggle="tooltip" data-placement="left">
                                                    <span class="glyphicon glyphicon-tint"></span>
                                                </span>
                                            </td>
                                        </tr>
                                        <tr id="rating-tr">
                                            <td>{% trans "豆瓣评分" %}</td>
                                            <td>
                                                <strong id="rating-av"></strong>
                                                <span class="text-muted rating-aux"> / 10</span>
                                                <span class="text-muted small hidden">
                                                    （<span class="glyphicon"></span>
                                                    <span id="rate-number"></span>）
                                                </span>
                                            </td>
                                        </tr>
                                        <tr id="tag-tr">
                                            <td id="tag-label">{% trans "标签" %}</td>
                                            <td id="tag-tag">{% trans "无" %}</td>
                                        </tr>
                                    </table>
                                </div><!--.panel-body-->
                            </div><!--.panel-->
                        </div><!--.col#right-half-panel-->
                    </div><!--.row-->
                </div><!-- .panel-body -->
                <div class="panel-footer hide-when-edit">
                    <div class="row">
                        <div class="col-xs-12">
                            <a class="btn btn-danger" id="delete" role="button" onclick="FORM.confirmDelete()">
                                <span class="glyphicon glyphicon-trash"></span>
                                {% trans "彻底删除" %}
                            </a>
                            <span class="pull-right">
                                {% if prg.status == "deactivated" %}
                                    <a id="reactivate" class="btn btn-warning" role="button" onclick="$('#reactivateform').submit()">
                                        <span class="glyphicon glyphicon-ok-circle"></span>
                                        {% trans "激活" %}
                                    </a>
                                {% else %}
                                    <a id="deactivate" class="btn btn-warning" role="button" onclick="$('#deactivateform').submit()">
                                        <span class="glyphicon glyphicon-ban-circle"></span>
                                        {% trans "冻结" %}
                                    </a>
                                {% endif %}
                            </span>
                        </div><!-- .col -->
                    </div><!-- .row -->
                </div><!-- panel-footer -->
            </div><!-- .panel -->
        </div><!--col-->
    </div><!--row-->
    <form id="deleteform" action="/progress/delete/" method="post">
        {% csrf_token %}
        <input name="id" type="hidden" value="{{prg.id}}">
    </form>
    <form id="deactivateform" action="/progress/deactivate/" method="post">
        {% csrf_token %}
        <input name="id" type="hidden" value="{{prg.id}}">
    </form>
    <form id="reactivateform" action="/progress/reactivate/" method="post">
        {% csrf_token %}
        <input name="id" type="hidden" value="{{prg.id}}">
    </form>
</div>
{% endblock content %}

{% block js %}
<script>
    $(function(){
        for (k in FORM.INPUTS){  // 初始化 FORM.INPUTS
            FORM.INPUTS[k] = $('input[name="' + k + '"]')
        }
        OPUS.INFOSETS.original.name = FORM.INPUTS.name.val()  // 作品数据库名
        OPUS.initInfo()
        FORM.checkEditMode()
        RENDER.syncTotal()
        $('[data-toggle="tooltip"]').tooltip();
        $('input.editable').keydown(function(){
            if(event.keyCode==13){
                $('#save').click()
                return false
            }
        })
        $('input.editable').on('input', function(){
            FORM.checkEditMode()
        })
    });
    var FORM = {
        /**
         * 全局定义输入框，主要用于代码可读性
         */
        "INPUTS": {
            name: null,
            comment: null,
            weblink: null,
            total: null,
            current: null,
        },
        /**
         * 在当前进度栏内，点击 + 号
         */
        "addOneCurrent": function(){
            if(!FORM.fullValidation()){
                return false
            }
            if(parseInt(FORM.INPUTS.total.val()) > 0 && parseInt(FORM.INPUTS.current.val()) == parseInt(FORM.INPUTS.total.val())){
                $.warning("{% trans '进度已达到最大值' %}");
                return false;
            }
            FORM.INPUTS.current.val(parseInt(FORM.INPUTS.current.val()) + 1);
            FORM.checkEditMode()
        },
        /**
         * 根据编辑框的值是否变化决定进入/退出编辑模式
         */
        "checkEditMode": function(){
            /**
             * 遍历检测编辑框是否有值发生改变
             * @return {Boolean}
             */
            function isEditableChanged(){
                var is_changed = false
                $('.editable').each(function(){
                    if($(this).val() != this.dataset.original){
                        is_changed = true
                    }
                })
                return is_changed
            }

            if(isEditableChanged()){
                RENDER.enterEdit()
            } else {
                RENDER.exitEdit()
            }
        },
        /**
        * 取消编辑，还原所有输入框至编辑前
        */
        'cancelEdit': function(){
            $('.editable').each(function(){
                $(this).val(this.dataset.original)
            })
            FORM.checkEditMode()
        },
        /**
        * 保存当前编辑的内容
        */
        'saveEdit': function(){
            if(FORM.fullValidation()){
                disableAllBtn()
                $('#saveform').submit();
                return true
            } else {
                return false
            }
        },
        /**
         * 点击删除时，最后确认的框
         */
        'confirmDelete': function(){
            var result = confirm("{% trans '确定删除此进度？' %}\n{% trans '（' %}{% trans '删除操作不可恢复' %}{% trans '）' %}")
            if(result){
                disableAllBtn()
                $("#deleteform").submit();
            } else {
                $.info("{% trans '删除操作已取消' %}")
            }
        },
        /**
         * 验证所有输入框的合法性
         */
        'fullValidation': function(){
            if(FORM.INPUTS.name.val() == ""){
                $.danger("{% trans '名称不能为空' %}")
                return false;
            }
            if(FORM.INPUTS.total.val() == '∞' || FORM.INPUTS.total.val() == ""){
                FORM.INPUTS.total.val(0);
            }
            if(FORM.INPUTS.current.val() == ''){
                FORM.INPUTS.current.val(0)
            }
            if(isNaN(FORM.INPUTS.current.val())){
                $.danger("{% trans '输入的更新的进度' %} " +  FORM.INPUTS.current.val() + " {% trans '必须是纯数字' %}{% trans '！' %}")
                return false;
            }
            if(parseInt(FORM.INPUTS.total.val()) > 0 && parseInt(FORM.INPUTS.current.val()) > parseInt(FORM.INPUTS.total.val())){
                $.danger("{% trans '错误' %}{% trans '：' %}{% trans '当前进度' %} " + FORM.INPUTS.current.val() + " " + "{% trans '大于' %}{% trans '总共' %}" + " " + FORM.INPUTS.total.val())
                return false;
            }
            return true
        },
    }
    var OPUS = {
        /**
         * 全局存放当前作品的两组信息
         * @param {INFOSET} original    [以原始名为准获取的各种信息]
         * @param {INFOSET} purified    [以去除章节名为准获取的各种信息]
         * @param {String}  type        [保存作品的类型]
         *    'init': 交由程序判断
         *    'book': 信息按照书处理
         *    'movie': 信息按照影视处理
         *    ‘compare': 同时获取书和影视的信息，并将两者进行比较
         */
        'INFOSETS': {
            original: {
                name: '',
                book: {},
                movie: {},
                guess: {},
            },
            purified: {
                name: '',
                book: {},
                movie: {},
                guess: {},
            },
            type: '',
        },
        /**
         * 预设的副标题列表及分类
         */
        "SUBS": {
            "book": [
                "书", "book", "{% trans '书' %}",
                "pdf",
                "漫画", "comic", "{% trans '漫画' %}",
                "文字", "doc", "txt",
                "小说", "novel", "{% trans '小说' %}",
                "kindle"
            ],
            "movie": [
                "动画", "anime", "{% trans '动画' %}",
                "电视剧", "tv", "show", "series", "{% trans '电视剧' %}",
                "公开课", "lesson", "{% trans '公开课' %}",
                "纪录片", "documentary", "{% trans '纪录片' %}",
                "视频", "video", "{% trans '视频' %}",
                "电影", "movie", "mv", "美剧", "英剧", "韩剧", "日剧"
            ],
        },
        /**
         * 判断作品类型，并分别获取作品信息
         */
        'initInfo': function(){
            OPUS.purifyName()
            OPUS.setType('init')
            OPUS.getInfo(OPUS.INFOSETS.original)
            OPUS.getInfo(OPUS.INFOSETS.purified)
        },
        /**
         * 去除作品名称中的章节信息，并将其显示在旁边
         * @global OPUS.INFOSETS.purified.name [赋值去章节名]
         */
        'purifyName': function(){
            console.debug('OPUS.purifyName:')
            function extractChapInfo(opus_name, regex, prefix){
                prefix = typeof prefix !== 'undefined' ?  prefix : ""  // 默认前缀为空
                var matched_info = opus_name.match(regex)  // matched_info[0]: 包含符号的章节/周目信息, matched_info[1]: 干净的章节/周目信息
                if(matched_info){
                    var new_opus_name = $.trim(opus_name.replace(matched_info[0], ''))
                    console.debug("  New:'%s', Chapinfo:'%s'", new_opus_name, matched_info[0])
                    OPUS.INFOSETS.purified.name = new_opus_name
                    var chapinfo_chars = matched_info[1]
                    $('#opus-name').text(new_opus_name)
                    $('#opus-chapinfo').append($("<span class='badge'></span>").text(prefix + chapinfo_chars))
                    return new_opus_name
                }
                return null
            }
            var opus_name = $('#opus-name').text()
            var re_chapter = /[\s（\(](第*[0-9一二三四五六七八九十上下]+(季|册|卷|集|章|本|节|课))[\)）]*/i
            opus_name = extractChapInfo(opus_name, re_chapter) || opus_name
            var re_lap = /[\s（\(](第*[0-9一二三四五六七八九十]+(周目|遍))[\)）]*/i
            opus_name = extractChapInfo(opus_name, re_lap, "#") || opus_name
            var re_year = /[\s（\(]((19|20)[0-9]{2})[\)）]*$/i
            opus_name = extractChapInfo(opus_name, re_year, "@") || opus_name
        },
        /**
         * 设定作品的类型
         * @param {String}  opustype    [作品类型]
         * @see OPUS.INFOSETS.type
         */
        'setType': function(opustype){
            console.debug('OPUS.setType: ' + opustype)
            /**
             * 用于判断 sub 内是否包含 subs 里的元素
             * @param {string}  sub     [作品信息的副标题]
             * @param {list}    subs    [预设的作品信息副标题分类]
             */
            function isInSubs(sub, subs){
                for(var i in subs){
                    if(sub.indexOf(subs[i]) >= 0){
                        return true
                    }
                }
                return false
            }

            if(opustype == 'init'){
                var sub = FORM.INPUTS.comment.val().toLowerCase()
                if(isInSubs(sub, OPUS.SUBS.book)){
                    OPUS.setType('book')
                } else if(isInSubs(sub, OPUS.SUBS.movie)){
                    OPUS.setType('movie')
                } else {
                    OPUS.setType('compare')
                }
            } else {
                OPUS.INFOSETS.type = opustype
            }
        },
        /**
         * 获取作品信息的入口，负责分辨作品的类别
         * @see 参考印象笔记
         * @param {INFOSET} infoset [以 original 还是 purified 组的作品信息们为准]
         */
        'getInfo': function(infoset){
            console.debug('OPUS.getInfo: %s @ %s', infoset.name, OPUS.INFOSETS.type)
            infoset.book = {}
            infoset.movie = {}
            infoset.guess = {}
            if(infoset.name){
                RENDER.showLoading("on")
                if(OPUS.INFOSETS.type == 'book'){
                    OPUS.getBookInfo(infoset)
                } else if(OPUS.INFOSETS.type == 'movie'){
                    OPUS.getMovieInfo(infoset)
                } else {  // OPUS.INFOSETS.type == 'compare'
                    OPUS.getBookInfo(infoset)
                    OPUS.getMovieInfo(infoset)
                }
            }
        },
        /**
         * 从豆瓣获得书类的信息并存入全局变量
         */
        'getBookInfo': function(infos){
            console.debug('  OPUS.getBookInfo: %s @ %s', infos.name, OPUS.INFOSETS.type)
            if(infos.name){
                OpusInfoGetter.getBookInfo(infos.name, function(info){
                    infos.book = info;
                    infos.book.finish = true;
                    OPUS.manageInfo()
                });
            }
        },
        /**
         * 从豆瓣获得影视类的信息并存入全局变量
         */
        'getMovieInfo': function(infos){
            console.debug('  getMovieInfo: %s @ %s', infos.name, OPUS.INFOSETS.type)
            if(infos.name){
                OpusInfoGetter.getMovieInfo(infos.name, function(info){
                    infos.movie = info;
                    infos.movie.finish = true;
                    OPUS.manageInfo()
                });
            }
        },
        /**
         * 获得的 Info 集中在这里管理
         * 已知 opus 类型，则在原名信息与去章节名信息之间选择
         * 未知 opus 类型，交给 judgeOpusType 判断类型
         */
        'manageInfo': function(){
            /**
             * 判断信息是否完全取回来了
             * @param {String}  set ['original' | 'purified']
             * @param {String}  typ ['book' | 'movie' | else]
             * @param {Boolean} OPUS.INFOSETS._._.finish    [是否查询了 original/purified 中的 book/movie（本地控制）]
             * @param {Boolean} OPUS.INFOSETS._._.exist     [查询的 book/movie 是否有结果]
             * @param {Boolean} OPUS.INFOSETS._._.match     [book/movie 的结果是否精确]
             * @return {Boolean}    [对应的 set typ 信息是否已试图加载过]
             */
            function isInfoReady(set, typ){
                console.debug('  isInfoReady: %s @ %s', set, typ)
                if(typ == 'book' || typ == 'movie'){  // typ 固定
                    if(!OPUS.INFOSETS[set].name){  // 没有名字（无法查询）
                        return true
                    } else if(OPUS.INFOSETS[set][typ].finish){  // 有名字，且查询完成
                        return true
                    }
                } else {  // typ == 'compare'
                    if(isInfoReady(set, 'book') && isInfoReady(set, 'movie')){
                        return true
                    }
                }
                return false
            }

            console.count('OPUS.manageInfo')
            RENDER.showLoading("off")
            if(!isInfoReady('original', OPUS.INFOSETS.type) || !isInfoReady('purified', OPUS.INFOSETS.type)){  // 请求尚未完成
                console.debug('OPUS.manageInfo: not ready')
                return false
            }
            if(OPUS.INFOSETS.type == 'book' || OPUS.INFOSETS.type == 'movie'){
                var orig = OPUS.INFOSETS.original[OPUS.INFOSETS.type]
                var puri = OPUS.INFOSETS.purified[OPUS.INFOSETS.type]
                if(orig.exist && orig.match){  // original 存在且准确
                    RENDER.showInfo(OPUS.INFOSETS.original, OPUS.INFOSETS.type)
                } else if(puri.exist && puri.match){  // purified 存在且准确
                    RENDER.showInfo(OPUS.INFOSETS.purified, OPUS.INFOSETS.type)
                } else if(orig.exist && !orig.match){  // original 存在但不准确
                    RENDER.showGuess(OPUS.INFOSETS.original, OPUS.INFOSETS.type)
                } else if(puri.exist && !puri.match){  // purified 存在但不准确
                    RENDER.showGuess(OPUS.INFOSETS.purified, OPUS.INFOSETS.type)
                } else {  // original/purified 都不存在
                    return false
                }
            } else {  // OPUS.INFOSETS.type == 'compare'
                OPUS.judgeType()
            }
        },
        /**
         * 智能判断作品信息的类别。
         */
        'judgeType': function(){
            /**
             * 先进行原名信息的判断，后进行去章节名信息的判断，判断过程没有满足特定条件则跳过，最终默认为影视
             * @param {INFOSET} infoset [以 original 还是 purified 组的作品信息们为准]
             * @return {Boolean} [是否成功判断出了当前 infoset 的类型]
             */
            function judgeInfoType(infoset){
                var total = FORM.INPUTS.total.val() || '0'
                if(infoset.book.exist && infoset.movie.exist){  // 都存在
                    if(infoset.book.match && !infoset.movie.match){  // 书精确，电影不精确
                        OPUS.setType('book')
                    } else if(!infoset.book.match && infoset.movie.match){  // 书不精确，电影精确
                        OPUS.setType('movie')
                    } else if(parseInt(total) == 0){  // follow 追剧中
                        OPUS.setType('movie')
                    } else if(parseInt(total) == parseInt(infoset.book.pages)){  // 页数相同
                        OPUS.setType('book')
                    } else {  // 都存在且均 match 或不 match
                        return false
                    }
                } else if(infoset.book.exist && !infoset.movie.exist){  // 只有书存在
                    OPUS.setType('book')
                } else if(!infoset.book.exist && infoset.movie.exist){  // 只有电影存在
                    OPUS.setType('movie')
                } else {  // 都不存在时
                    return false
                }
                return true
            }

            console.debug('judgeOpusType: %s', OPUS.INFOSETS.type)
            var total = FORM.INPUTS.total.val() || 0
            if(!judgeInfoType(OPUS.INFOSETS.original) && !judgeInfoType(OPUS.INFOSETS.purified)){  // 如果都未匹配上
                OPUS.setType('movie')  // 默认为影视作品
            }
            OPUS.manageInfo()
        },
    }
    var RENDER = {
        /**
         * 将全局变量中的某个作品信息显示在网页上
         * @param {INFOSET} infoset [以 original 还是 purified 组的作品信息们为准]
         */
        "showInfo": function(infoset, typ){
            console.debug('showInfo: ' + infoset[typ].title)
            info = infoset[typ]
            $('#title-link').attr('href', info.url)
            $('#title-link').text(info.title)
            var img_container = $('<div></div>')
            var img_a = $('<a></a>').attr('href', info.images.large).attr('target', '_blank').appendTo(img_container)
            var img_sm = $('<img>').attr('src', info.images.small).width('100%').appendTo(img_a)
            var cover_ele = $('#opus-cover')
            cover_ele.tooltip({
                html: true,
                container: 'body',
                title: img_container.html(),
                placement: 'bottom',
                trigger: 'click',
            })
            cover_ele.on('show.bs.tooltip', function(){
                $(this).addClass('active')
            })
            cover_ele.on('hide.bs.tooltip', function(){
                $(this).removeClass('active')
            })
            if(info.summary){
                $('#opus-wordcloud').attr('src', '/opus/getopuswordcloud?height=100&width=500&type=' + info.type + '&name=' + infoset.name)
            }
            $('#tag-tag').text(info.tags.join('，'))
            $('#rating-av').text(info.rating)
            if(info.type == 'book'){
                $('#original-title').text(info.origin_title)
                $('#rate-number').text(info.numrater).siblings('.glyphicon').addClass('glyphicon-user')
                $('#opus-type-icon').addClass('glyphicon-book')
                $('#speed-unit').text("{% trans '每页' %}")
            } else if(info.type == 'movie'){
                $('#original-title').text(info.original_title)
                $('#rate-number').text(info.stars).siblings('.glyphicon').addClass('glyphicon-star')
                $('#opus-type-icon').addClass('glyphicon-film')
                $('#speed-unit').text("{% trans '每集' %}")
            }
            $('#opus-type-a').attr('title', info.title)
            $('#opus-type-a').attr('href', info.api)
            RENDER.showImageColor(info)
            RENDER.checkInfoVisibility(info)
        },
        /**
         * 将猜测的可能的作品信息显示在网页上
         * @param {INFOSET} infoset [以 original 还是 purified 组的作品信息们为准]
         */
        'showGuess': function(infoset, typ){
            console.debug('showGuess:' + infoset[typ].title)
            infoset.guess = infoset[typ]
            var title_a = '<a href="' + infoset.guess.url + '" target="_blank">' + infoset.guess.title + '</a>'
            var guess_title = "《" + title_a + "》"
            var guess_subtype = infoset.guess.subtype ? "{% trans '（' %}" + infoset.guess.subtype.toUpperCase() + "{% trans '）' %}" : ''
            var apply_guess = "<span id='apply-guess' class='text-success glyphicon glyphicon-ok img-thumbnail' onclick='RENDER.applyGuess(\"" + infoset.guess.title + "\")'></span>"
            var content_html = "{% trans '是' %} " + guess_title + guess_subtype + " {% trans '吗？' %}" + apply_guess
            $('#name-tr').popover({
                delay: {'show':0, 'hide':0},
                html: true,
                trigger: 'focus',
                container: 'body',
                content: function(){
                    return content_html
                },
            });
        },
        /**
         * 当用户应用猜测作品信息时
         * @param {String}  title   [需要应用的标题]
         */
        'applyGuess': function(title){
            FORM.INPUTS.name.val(title)
            FORM.checkEditMode()
        },
        /**
         * 显示读取中的动画
         * @param {String}  mode    ["on" 显示动画 | "off" 停止动画]
         */
        'showLoading': function(mode){
            if(mode=="on"){
                $('#loading-icon').fadeIn()
            } else {
                $('#loading-icon').fadeOut()
            }
        },
        /**
         * 通过作品封面计算作品代表色，并显示在网页上
         * @param {INFO}    info    [需要应用的作品的信息]
         */
        'showImageColor': function(info){
            OpusInfoGetter.getImageColor(info.images.small, '{{opus.id}}', function(result){
                $('#color-indicator').css('color', result.color)
            });
        },
        /**
         * 检查作品信息可见性
         * @param {INFO}    info    [需要应用的作品的信息]
         * @return {Boolean}    [是否显示整个面板]
         */
        'checkInfoVisibility': function(info){
            if(!info || !info.exist || !info.match){  // 作品不存在、未精确匹配时不显示整个面板
                return false
            } else  {  // 作品存在且精确匹配
                $('#title-tr').popover('destroy')
                $("#douban-info-panel").addClass('viewmode').fadeIn()
                if(info.tags.length != 0){  // 作品有 tag
                    $('#tag-tr').show()
                }
                if(info.rating && parseInt(info.rating) > 0){  // 作品评分 > 0
                    $('#rating-tr').show()
                }
                if(info.title){
                    $('#title-tr').show()
                }
                if($('#rate-number').text()){
                    $('#rate-number').parent().removeClass('hidden')
                }
                return true
            }
        },
        /**
        * 进入编辑模式，隐藏不是编辑时的锁用到的栏，并显示保存、取消按钮
        */
        'enterEdit': function(){
            $('.hide-when-edit').hide()
            $('.show-when-edit').fadeIn()
        },
        /**
        * 退出编辑模式，显示所有栏，并隐藏保存、取消按钮
        */
        'exitEdit': function(){
            $('.hide-when-edit').fadeIn()
            $('.show-when-edit').hide()
        },
        /**
         * “总共” input 框内数值同步至“当前进度”里面的总共
         */
         'syncTotal': function(){
            var target_ele = $('#total-as-feedback')
            if(FORM.INPUTS.total.val() == "" || FORM.INPUTS.total.val() == '∞' || FORM.INPUTS.total.val() == '0'){
                target_ele.text('∞')
            } else {
                target_ele.text(FORM.INPUTS.total.val())
            }
        },
    }
</script>
{% endblock js %}
