{% extends "progress/base-list.html" %}
{% load i18n %}

{% block title %}{% trans "进度历程" %}{% endblock title %}


{% block inhead %}
    {{ block.super }}
    <link rel="stylesheet" href="/static/3rd/jqtimeline/css/jquery.jqtimeline.zh.css">
    <script src="/static/3rd/jqtimeline/js/jquery.jqtimeline.zh.js"></script>
    <link rel="stylesheet" href="/static/3rd/jquery-timelineme/jquery.timelineMe.css">
    <script src="/static/3rd/jquery-timelineme/jquery.timelineMe.js"></script>
{% endblock %}

{% block css %}
    <style>
        /* timeline */
        #hide-timeline {
            text-align: center;
            font-size: 16px;
        }
        #hide-timeline__trigger {
            z-index: 2;
            border-radius: 100%;
            cursor: n-resize;
        }
        #hide-timeline__trigger:hover {
            color: red;
            -webkit-transform: rotate(360deg) scale(1.2);
               -moz-transform: rotate(360deg) scale(1.2);
                -ms-transform: rotate(360deg) scale(1.2);
                 -o-transform: rotate(360deg) scale(1.2);
                    transform: rotate(360deg) scale(1.2);
        }
        .timeline-me-label .timeline-me-same-position {  /* Hack timelineme */
            display: none;
        }
        .timeline-me-smallitem .timeline-me-fullcontent .timeline-me-same-position,
        .timeline-me-smallitem .timeline-me-shortcontent .timeline-me-same-position {  /* Hack timelineme */
            display: block;
            border-top: 1px solid silver;
            margin-top: 10px;
            padding-top: 10px;
        }
        @media (max-width: 768px) {
            .well-in-sm {  /* Hack bootstrap's well */
                padding: 0;
            }
            .timeline-me-smallitem.timeline-me-left .timeline-me-content-container, .timeline-me-smallitem:not(.timeline-me-top):not(.timeline-me-right):not(.timeline-me-bottom) .timeline-me-content-container {  /* Hack timelineme */
                width: 45%;
                margin-left: 5%;
            }
            .timeline-me-smallitem.timeline-me-right .timeline-me-content-container {  /* Hack timelineme */
              width: 45%;
            }
        }
        .timeline-me-item {
            margin: 0;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <div id="timeline-zone" class="row hidden-xs">
            <div class="col-xs-12 well">
                <div id="hide-timeline">
                    <span id="hide-timeline__trigger" class="fas fa-chevron-up text-muted ani-normal" onmouseenter="hideTimeline()" onmouseout="stopHideTimeline()"></span>
                </div>
                <div id="timeline-zone-years">
                    <!-- contents generated by JS -->
                </div>
            </div><!--.col-->
        </div>
        <div id="timelineme-zone" class="row">
            <div class="col-xs-12 well well-in-sm">
                <div id="timelineme">
                    <!-- contents generated by JS -->
                </div>
            </div><!--.col-->
        </div><!--row-->
    </div><!--.container-->

{% endblock content %}

{% block js %}
<script>
    $(function(){
        {% for year, prglist_per_year in prglist_by_year %}
            var this_year_events = [
                {% for prg in prglist_per_year %}
                    {% include "progress/timeline-event.html" with prg=prg %}
                {% endfor %}
            ];
            var timeline_div = $("<div data-year='{{ year }}'></div>")
            timeline_div.jqtimeline({
                events: this_year_events,  // this year
                startYear: {{ year }},
                showToolTip: true,
                gap: $('.container').width() / 12 * 0.9,
                numYears: 1,
                groupEventWithinPx: 9,
                click: function(e, event){
                    window.location='/progress/detail?id=' + event.progressid
                },
            })
            $("#timeline-zone-years").append(timeline_div)
        {% endfor %}

        $('#timelineme').timelineMe({
            // orientation: 'horizontal',
            items: [
                {% for prg in prglist %}
                    {% ifchanged prg.modified.year %}
                        {
                            label: '<h1><span class="label label-primary">{{ prg.modified.year }}</span></h1>',
                            type: 'bigItem',
                            // relativePosition: -{{ prg.modified|date:'Y' }}0000,  //-20170000
                        },
                    {% endifchanged %}
                    {% ifchanged prg.modified.month %}
                        {
                            label: '<span class="label label-primary">{{ prg.modified.year }}-{{ prg.modified.month }}</span>',
                            type: 'milestone',
                            // relativePosition: -{{ prg.modified|date:'Ym' }}00,  //-20170100
                        },
                    {% endifchanged %}
                    {
                        label: "<span class='text-muted'>{{ prg.modified|date:'Y-m-d' }}</span>",
                        type: "smallItem",
                        showMore: "",
                        showLess: "",
                        // relativePosition: -{{ prg.modified|date:'Ymd' }},  //-20170101
                        {% if prg.status == "done" %}
                            picto: "<span class='fas fa-check text-success'></span>",
                            shortContent: "<span class='text-success'>{% trans '完成了' %} </span>《{{ prg.link|safe }}》",
                            forcePosition: "right",
                        {% elif prg.status == "deactivated" %}
                            picto: "<span class='fas fa-icicles text-danger'></span>",
                            shortContent: "<span class='text-danger'>{% trans '冻结了' %} </span>《{{ prg.link|safe }}》",
                            forcePosition: "right",
                        {% elif prg.status == "inprogress" %}
                            picto: "<span class='fas fa-play'></span>",
                            shortContent: "《{{prg.link|safe}}》 {% trans '进行至' %} <span class='text-info'>{{ prg.persent }}%</span>",
                            forcePosition: "left",
                        {% elif prg.status == "follow" %}
                            picto: "<span class='fas fa-step-forward'></span>",
                            shortContent: "《{{ prg.link|safe }}》 {% trans '追剧至' %}<span class='text-info'> {% trans '第' %} {{ prg.current }} {% trans '集' %}</span>",
                            forcePosition: "left",
                        {% elif prg.status == "todo" %}
                            picto: "<span class='fas fa-plus'></span>",
                            shortContent: "《{{ prg.link|safe }}》 {% trans '加入至' %} <span class='text-info'>{% trans '待阅读' %}</span>",
                            forcePosition: "left",
                        {% else %}
                            shortContent: "《{{ prg.link|safe }}》 {% trans '出错' %}",
                            forcePosition: "left",
                        {% endif %}
                    },
                {% endfor %}
            ],  // items
        })  // .timelineMe(options)
    })  // $(function(){})

    var timer_hTl
    function hideTimeline(ele){
        clearTimeout(timer_hTl)
        timer_hTl = setTimeout(function(){
            $('#timeline-zone').slideUp('slow')
        }, 1000)
    }

    function stopHideTimeline(){
        clearTimeout(timer_hTl)
    }
</script>
{% endblock %}
