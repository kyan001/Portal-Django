{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "个人设置" %}{% endblock %}

{% block inhead %}
    {{ block.super }}
    <!-- ############ SERVICE WORKER ############-->
    <script>
        function registerServiceWorker () {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function () {
                    navigator.serviceWorker.register('/progress/service-worker.js').then(function (registration) {  // Registration was successful
                        console.debug('[Service Worker] Registration OK, Scope:', registration.scope)
                    }, function (err) {  // registration failed :(
                        console.debug('[Service Worker] Registration KO, Error:', err)
                    })
                })
            }
        }
        function unregisterServiceWorker () {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function (registrations) {
                    for (let registration of registrations) {
                        registration.unregister().then(function (isSuccess) {
                            if (isSuccess) {
                                console.debug('[Service Worker] Unregistration OK')
                            } else {
                                console.debug('[Service Worker] Unregistration KO')
                            }
                        })
                    }
                })
            }
        }
        {% if cuser.serviceworker_on %}
            registerServiceWorker()
        {% else %}
            unregisterServiceWorker()
        {% endif %}
    </script>
{% endblock inhead %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-xs-12 col-sm-10 col-sm-offset-1 col-md-8 col-md-offset-2">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <span class="glyphicon glyphicon-th"></span>
                    {% trans "进度日历设置" %}
                </div>
                <div class="panel-body">
                    <form id="ical-form" action="/progress/setical" method="post">
                        {% csrf_token %}
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="enable" value="on" {% if cuser.ical_on %}checked{% endif %} onchange="$('#ical-form').submit()"/>
                                {% trans "公开进度日历" %}
                            </label>
                            {% if cuser.ical_on %}
                                <a class="pull-right" href="/progress/ical?userid={{ cuser.id }}">
                                    {% trans "「进度日历」地址（公开）" %}
                                </a>
                            {% else %}
                                <a class="pull-right" href="/progress/ical?userid={{ cuser.id }}&private={{ privatekey }}">
                                    {% trans "「进度日历」地址（私人）" %}
                                </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12 col-sm-10 col-sm-offset-1 col-md-8 col-md-offset-2">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <span class="glyphicon glyphicon-signal"></span>
                    {% trans "离线缓存设置" %}
                </div>
                <div class="panel-body">
                    <form id="sw-form" action="/progress/setserviceworker" method="post">
                        {% csrf_token %}
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="enable" value="on" {% if cuser.serviceworker_on %}checked{% endif %} onchange="$('#sw-form').submit()"/>
                                {% trans "启用进度缓存" %}
                            </label>
                            <a class="pull-right" href="javascript:void(0);" onclick="$('#sw-guide').slideDown()" role="button">
                                <span class="glyphicon glyphicon-question-sign"></span>
                            </a>
                        </div>
                    </form>
                    <div id="sw-guide" class="row" hidden>
                        <div class="col-xs-12 col-md-6">
                            <div class="well">
                                <b>Win10 · Mac (Chrome):</b>
                                <ol>
                                    <li>{% trans "启动" %} Chrome</li>
                                    <li>
                                        {% trans "访问" %}
                                        <a href="/progress/list" target="_blank">
                                            <span class="glyphicon glyphicon-link"></span>
                                            {% trans "进度列表" %}
                                        </a>
                                    </li>
                                    <li>
                                        {% trans "请点击" %} <span class="text-primary glyphicon glyphicon-option-vertical"></span>
                                        {% trans "（" %}{% trans "在右上角" %}{% trans "）" %}</li>
                                    </li>
                                    <li>
                                        {% trans "选择" %}
                                        <mark>{% trans "安装" %}{% trans "“" %}{% trans "进度列表" %}{% trans "”" %} ...</mark>
                                    </li>
                                </ol>
                            </div><!--.well-->
                        </div><!--.col-->
                        <div class="col-xs-12 col-md-6">
                            <div class="well">
                                <b>iPhone · iPad (Safari):</b>
                                <ol>
                                    <li>{% trans "启动" %} Safari</li>
                                    <li>
                                        {% trans "访问" %}
                                        <a href="/progress/list" target="_blank">
                                            <span class="glyphicon glyphicon-link"></span>
                                            {% trans "进度列表" %}
                                        </a>
                                    </li>
                                    <li>
                                        {% trans "请点击" %} <img src="/static/img/apple-share-btn.png" alt="share button" height="21px" width="15px">
                                        {% trans "（" %}{% trans "在底部" %} · {% trans "在右上角" %}{% trans "）" %}</li>
                                    </li>
                                    <li>
                                        {% trans "选择" %}
                                        {% trans "“" %}{% trans "添加至主屏幕" %}{% trans "”" %}
                                    </li>
                                </ol>
                            </div><!--.well-->
                        </div><!--.col-->
                    </div><!--.row-->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
